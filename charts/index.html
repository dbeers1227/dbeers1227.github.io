<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OHLC Chart ¬∑ D. Beers</title>
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --color-bg: #f9f9f9;
      --color-surface: #ffffff;
      --color-border: #e4e4e7;
      --color-text: #18181b;
      --color-muted: #71717a;
      --color-accent: #2563eb;
      --color-accent-hover: #1d4ed8;
      --color-up: #16a34a;
      --color-down: #dc2626;
      --radius: 12px;
      --max-width: 1100px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      padding: 1.25rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .site-name {
      font-size: 1.125rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--color-text);
      text-decoration: none;
    }

    nav a {
      color: var(--color-muted);
      text-decoration: none;
      font-size: 0.9rem;
      margin-left: 1.5rem;
      transition: color 0.2s;
    }

    nav a:hover { color: var(--color-accent); }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    main {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 2.5rem 2rem 4rem;
    }

    .page-title {
      font-size: clamp(1.5rem, 4vw, 2rem);
      font-weight: 800;
      letter-spacing: -0.03em;
      margin-bottom: 0.4rem;
    }

    .page-subtitle {
      color: var(--color-muted);
      font-size: 0.95rem;
      margin-bottom: 2rem;
    }

    /* ‚îÄ‚îÄ Upload Zone ‚îÄ‚îÄ */
    #upload-zone {
      border: 2px dashed var(--color-border);
      border-radius: var(--radius);
      background: var(--color-surface);
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }

    #upload-zone.drag-over {
      border-color: var(--color-accent);
      background: #eff6ff;
    }

    #upload-zone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }

    .upload-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      display: block;
    }

    .upload-label {
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-text);
      display: block;
      margin-bottom: 0.3rem;
    }

    .upload-hint {
      font-size: 0.82rem;
      color: var(--color-muted);
    }

    .upload-hint code {
      background: #f1f5f9;
      border-radius: 4px;
      padding: 0.1rem 0.4rem;
      font-size: 0.78rem;
      font-family: ui-monospace, "Cascadia Code", monospace;
    }

    /* ‚îÄ‚îÄ Stats Bar ‚îÄ‚îÄ */
    #stats-bar {
      display: none;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1.5rem;
      padding: 1rem 1.25rem;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      align-items: center;
    }

    .stat {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .stat-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--color-muted);
    }

    .stat-value {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .stat-value.up   { color: var(--color-up); }
    .stat-value.down { color: var(--color-down); }

    .stat-divider {
      width: 1px;
      height: 2rem;
      background: var(--color-border);
    }

    .filename-badge {
      margin-left: auto;
      font-size: 0.78rem;
      color: var(--color-muted);
      background: #f1f5f9;
      border-radius: 6px;
      padding: 0.25rem 0.6rem;
      font-family: ui-monospace, "Cascadia Code", monospace;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ‚îÄ‚îÄ Chart ‚îÄ‚îÄ */
    #chart-wrapper {
      display: none;
      margin-top: 1.5rem;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--color-surface);
    }

    #chart-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .toolbar-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--color-text);
    }

    .toolbar-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      font-size: 0.78rem;
      font-weight: 500;
      padding: 0.3rem 0.75rem;
      border-radius: 6px;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      color: var(--color-text);
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }

    .btn:hover {
      background: #f1f5f9;
      border-color: #a1a1aa;
    }

    .btn.active {
      background: var(--color-accent);
      border-color: var(--color-accent);
      color: #fff;
    }

    #chart-container {
      width: 100%;
      height: 540px;
    }

    /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
    #error-msg {
      display: none;
      margin-top: 1rem;
      padding: 0.85rem 1.1rem;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      color: #b91c1c;
      font-size: 0.875rem;
    }

    /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
    footer {
      border-top: 1px solid var(--color-border);
      padding: 2rem;
      text-align: center;
      font-size: 0.85rem;
      color: var(--color-muted);
    }

    footer a {
      color: var(--color-accent);
      text-decoration: none;
    }

    footer a:hover { text-decoration: underline; }

    @media (max-width: 600px) {
      header { flex-direction: column; gap: 0.75rem; align-items: flex-start; }
      nav a:first-child { margin-left: 0; }
      #chart-container { height: 320px; }
    }
  </style>
</head>
<body>

  <header>
    <a class="site-name" href="/">D. Beers</a>
    <nav>
      <a href="/">‚Üê Home</a>
      <a href="https://github.com/dbeers1227" target="_blank" rel="noopener">GitHub</a>
    </nav>
  </header>

  <main>
    <h1 class="page-title">OHLC Chart Viewer</h1>
    <p class="page-subtitle">Upload a CSV file with market data to render an interactive candlestick chart.</p>

    <!-- Upload Zone -->
    <div id="upload-zone">
      <input type="file" id="file-input" accept=".csv,text/csv" />
      <span class="upload-icon">üìà</span>
      <span class="upload-label">Drop your CSV here or click to browse</span>
      <p class="upload-hint">
        Expected columns (case-insensitive):
        <code>date</code> &nbsp;<code>time</code> &nbsp;<code>open</code> &nbsp;<code>high</code> &nbsp;<code>low</code> &nbsp;<code>close</code> &nbsp;<code>up</code> &nbsp;<code>down</code>
        &nbsp;‚Äî where <code>up</code> / <code>down</code> are up &amp; down volume
      </p>
    </div>

    <!-- Error -->
    <div id="error-msg"></div>

    <!-- Stats Bar -->
    <div id="stats-bar">
      <div class="stat">
        <span class="stat-label">Candles</span>
        <span class="stat-value" id="stat-candles">‚Äî</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat">
        <span class="stat-label">From</span>
        <span class="stat-value" id="stat-from">‚Äî</span>
      </div>
      <div class="stat">
        <span class="stat-label">To</span>
        <span class="stat-value" id="stat-to">‚Äî</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat">
        <span class="stat-label">Period High</span>
        <span class="stat-value up" id="stat-high">‚Äî</span>
      </div>
      <div class="stat">
        <span class="stat-label">Period Low</span>
        <span class="stat-value down" id="stat-low">‚Äî</span>
      </div>
      <div class="stat-divider" id="vol-divider" style="display:none"></div>
      <div class="stat" id="stat-up-wrap" style="display:none">
        <span class="stat-label">Up Vol</span>
        <span class="stat-value up" id="stat-up-vol">‚Äî</span>
      </div>
      <div class="stat" id="stat-down-wrap" style="display:none">
        <span class="stat-label">Down Vol</span>
        <span class="stat-value down" id="stat-down-vol">‚Äî</span>
      </div>
      <span class="filename-badge" id="stat-filename"></span>
    </div>

    <!-- Chart -->
    <div id="chart-wrapper">
      <div id="chart-toolbar">
        <span class="toolbar-title" id="toolbar-label">Candlestick Chart</span>
        <div class="toolbar-actions">
          <button class="btn active" id="btn-candle">Candles</button>
          <button class="btn" id="btn-bar">Bar</button>
          <button class="btn" id="btn-line">Line</button>
          <button class="btn" id="btn-reset">Reset zoom</button>
        </div>
      </div>
      <div id="chart-container"></div>
    </div>
  </main>

  <footer>
    <p>
      Built by <a href="https://github.com/dbeers1227" target="_blank" rel="noopener">D. Beers</a>
      &nbsp;¬∑&nbsp;
      <a href="https://github.com/dbeers1227/dbeers1227.github.io" target="_blank" rel="noopener">Source</a>
    </p>
  </footer>

<script>
  // ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const uploadZone     = document.getElementById('upload-zone');
  const fileInput      = document.getElementById('file-input');
  const errorMsg       = document.getElementById('error-msg');
  const statsBar       = document.getElementById('stats-bar');
  const chartWrapper   = document.getElementById('chart-wrapper');
  const chartContainer = document.getElementById('chart-container');

  const statCandles  = document.getElementById('stat-candles');
  const statFrom     = document.getElementById('stat-from');
  const statTo       = document.getElementById('stat-to');
  const statHigh     = document.getElementById('stat-high');
  const statLow      = document.getElementById('stat-low');
  const statUpVol    = document.getElementById('stat-up-vol');
  const statDownVol  = document.getElementById('stat-down-vol');
  const statUpWrap   = document.getElementById('stat-up-wrap');
  const statDownWrap = document.getElementById('stat-down-wrap');
  const volDivider   = document.getElementById('vol-divider');
  const statFilename = document.getElementById('stat-filename');
  const toolbarLabel = document.getElementById('toolbar-label');

  const btnCandle = document.getElementById('btn-candle');
  const btnBar    = document.getElementById('btn-bar');
  const btnLine   = document.getElementById('btn-line');
  const btnReset  = document.getElementById('btn-reset');

  // ‚îÄ‚îÄ Chart state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let chart        = null;
  let activeSeries = null;
  let parsedData   = [];
  let currentMode  = 'candle';
  let currentFile  = '';

  // ‚îÄ‚îÄ Drag-and-drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  uploadZone.addEventListener('dragover', e => {
    e.preventDefault();
    uploadZone.classList.add('drag-over');
  });

  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('drag-over');
  });

  uploadZone.addEventListener('drop', e => {
    e.preventDefault();
    uploadZone.classList.remove('drag-over');
    const file = e.dataTransfer?.files?.[0];
    if (file) processFile(file);
  });

  fileInput.addEventListener('change', () => {
    if (fileInput.files[0]) processFile(fileInput.files[0]);
  });

  // ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  btnCandle.addEventListener('click', () => switchMode('candle'));
  btnBar.addEventListener('click',    () => switchMode('bar'));
  btnLine.addEventListener('click',   () => switchMode('line'));
  btnReset.addEventListener('click',  () => chart?.timeScale().fitContent());

  function setActiveBtn(mode) {
    [btnCandle, btnBar, btnLine].forEach(b => b.classList.remove('active'));
    ({ candle: btnCandle, bar: btnBar, line: btnLine })[mode].classList.add('active');
  }

  function switchMode(mode) {
    if (!parsedData.length) return;
    currentMode = mode;
    setActiveBtn(mode);
    renderChart(parsedData, currentFile);
  }

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showError(msg) {
    errorMsg.textContent = '‚ö† ' + msg;
    errorMsg.style.display = 'block';
  }

  function clearError() {
    errorMsg.style.display = 'none';
    errorMsg.textContent = '';
  }

  /** Finds column index by trying multiple name variants (case-insensitive). */
  function findCol(headers, ...names) {
    const lower = headers.map(h => h.trim().toLowerCase());
    for (const name of names) {
      const idx = lower.indexOf(name.toLowerCase());
      if (idx !== -1) return idx;
    }
    return -1;
  }

  /**
   * Combines separate date and time strings ‚Üí Unix seconds.
   * Handles compact formats: YYYYMMDD, HHMMSS, HHMM.
   */
  function parseDateTimeToUnix(dateStr, timeStr) {
    dateStr = String(dateStr).trim();
    timeStr = String(timeStr).trim();

    // Normalise compact date: YYYYMMDD ‚Üí YYYY-MM-DD
    if (/^\d{8}$/.test(dateStr)) {
      dateStr = `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
    }

    // Normalise compact time: HHMMSS ‚Üí HH:MM:SS, HHMM ‚Üí HH:MM:00
    if (/^\d{6}$/.test(timeStr)) {
      timeStr = `${timeStr.slice(0,2)}:${timeStr.slice(2,4)}:${timeStr.slice(4,6)}`;
    } else if (/^\d{4}$/.test(timeStr)) {
      timeStr = `${timeStr.slice(0,2)}:${timeStr.slice(2,4)}:00`;
    }

    let d = new Date(`${dateStr}T${timeStr}`);
    if (!isNaN(d.getTime())) return Math.floor(d.getTime() / 1000);

    d = new Date(`${dateStr} ${timeStr}`);
    if (!isNaN(d.getTime())) return Math.floor(d.getTime() / 1000);

    return null;
  }

  /**
   * Parses a standalone date/timestamp string ‚Üí 'YYYY-MM-DD' or Unix seconds.
   */
  function parseTime(raw) {
    const s = String(raw).trim();
    if (/^\d{9,10}$/.test(s)) return parseInt(s, 10);
    if (/^\d{13}$/.test(s))   return Math.floor(parseInt(s, 10) / 1000);

    const d = new Date(s);
    if (!isNaN(d.getTime())) {
      const y  = d.getFullYear();
      const mo = String(d.getMonth() + 1).padStart(2, '0');
      const dy = String(d.getDate()).padStart(2, '0');
      return `${y}-${mo}-${dy}`;
    }
    return null;
  }

  /** Formats a stored time value for human display. */
  function formatTimeLabel(t) {
    if (typeof t === 'number') {
      const d = new Date(t * 1000);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    return String(t).substring(0, 10);
  }

  // ‚îÄ‚îÄ CSV parser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function parseCSV(text) {
    const lines = text.replace(/^\uFEFF/, '').split(/\r?\n/).filter(l => l.trim());
    if (lines.length < 2) throw new Error('CSV must have a header row and at least one data row.');

    // Auto-detect delimiter: semicolon, tab, or comma
    const delim = lines[0].includes(';') ? ';' : lines[0].includes('\t') ? '\t' : ',';
    const headers = lines[0].split(delim).map(h => h.trim().replace(/^"|"$/g, ''));

    // ‚îÄ‚îÄ Timestamp columns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Prefer separate 'date' + 'time' columns; fall back to a single column.
    const iDateOnly = findCol(headers, 'date');
    const iTimeOnly = findCol(headers, 'time');
    const hasDateTime = iDateOnly >= 0 && iTimeOnly >= 0;

    const iTimestamp = hasDateTime
      ? -1
      : findCol(headers, 'date', 'datetime', 'timestamp', 'time',
                'Date', 'Datetime', 'Timestamp', 'Time');

    // ‚îÄ‚îÄ OHLC columns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const iOpen  = findCol(headers, 'open',  'Open',  'OPEN');
    const iHigh  = findCol(headers, 'high',  'High',  'HIGH');
    const iLow   = findCol(headers, 'low',   'Low',   'LOW');
    const iClose = findCol(headers, 'close', 'Close', 'CLOSE', 'adj close', 'Adj Close');

    // ‚îÄ‚îÄ Volume columns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // New format: separate 'up' and 'down' columns for up/down volume.
    const iUp   = findCol(headers, 'up',   'Up',   'UP',   'upvol',   'up_vol',   'up volume');
    const iDown = findCol(headers, 'down', 'Down', 'DOWN', 'downvol', 'down_vol', 'down volume');
    // Legacy fallback: single 'volume' column
    const iVol  = (iUp >= 0 || iDown >= 0)
      ? -1
      : findCol(headers, 'volume', 'Volume', 'VOLUME', 'vol');

    // ‚îÄ‚îÄ Validate required columns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const missing = [];
    if (!hasDateTime && iTimestamp < 0) missing.push('date');
    if (iOpen  < 0) missing.push('open');
    if (iHigh  < 0) missing.push('high');
    if (iLow   < 0) missing.push('low');
    if (iClose < 0) missing.push('close');
    if (missing.length) {
      throw new Error(`Could not find column(s): ${missing.join(', ')}. Headers found: ${headers.join(', ')}`);
    }

    // ‚îÄ‚îÄ Parse rows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(delim).map(c => c.trim().replace(/^"|"$/g, ''));
      if (cols.length < 5) continue;

      const time = hasDateTime
        ? parseDateTimeToUnix(cols[iDateOnly], cols[iTimeOnly])
        : parseTime(cols[iTimestamp]);

      const open  = parseFloat(cols[iOpen]);
      const high  = parseFloat(cols[iHigh]);
      const low   = parseFloat(cols[iLow]);
      const close = parseFloat(cols[iClose]);

      if (time === null || isNaN(open) || isNaN(high) || isNaN(low) || isNaN(close)) continue;

      const row = { time, open, high, low, close, value: close };

      if (iUp   >= 0) row.upVol   = parseFloat(cols[iUp])   || 0;
      if (iDown >= 0) row.downVol = parseFloat(cols[iDown]) || 0;
      if (iVol  >= 0) row.upVol   = parseFloat(cols[iVol])  || 0; // legacy

      rows.push(row);
    }

    if (!rows.length) throw new Error('No valid rows found after parsing. Check that your date and numeric columns are correct.');

    rows.sort((a, b) => (a.time < b.time ? -1 : a.time > b.time ? 1 : 0));

    // Remove duplicate timestamps
    const seen = new Set();
    return rows.filter(r => {
      const k = String(r.time);
      if (seen.has(k)) return false;
      seen.add(k);
      return true;
    });
  }

  // ‚îÄ‚îÄ Chart render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderChart(data) {
    if (chart) { chart.remove(); chart = null; activeSeries = null; }

    const hasVolume = data.some(d => d.upVol !== undefined || d.downVol !== undefined);

    chart = LightweightCharts.createChart(chartContainer, {
      layout: {
        background: { color: '#ffffff' },
        textColor:  '#18181b',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
        fontSize:   12,
      },
      grid: {
        vertLines: { color: '#f1f5f9' },
        horzLines: { color: '#f1f5f9' },
      },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
      rightPriceScale: { borderColor: '#e4e4e7' },
      timeScale: { borderColor: '#e4e4e7', timeVisible: true, secondsVisible: false },
      handleScroll: true,
      handleScale:  true,
    });

    // Resize observer
    const ro = new ResizeObserver(() => {
      if (chart) chart.applyOptions({ width: chartContainer.clientWidth });
    });
    ro.observe(chartContainer);

    // Push OHLC series up to leave room for volume at the bottom
    if (hasVolume) {
      chart.priceScale('right').applyOptions({
        scaleMargins: { top: 0.05, bottom: 0.26 },
      });
    }

    // ‚îÄ‚îÄ Main OHLC series ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (currentMode === 'candle') {
      activeSeries = chart.addCandlestickSeries({
        upColor:         '#16a34a',
        downColor:       '#dc2626',
        borderUpColor:   '#16a34a',
        borderDownColor: '#dc2626',
        wickUpColor:     '#16a34a',
        wickDownColor:   '#dc2626',
      });
      toolbarLabel.textContent = 'Candlestick Chart';
    } else if (currentMode === 'bar') {
      activeSeries = chart.addBarSeries({ upColor: '#16a34a', downColor: '#dc2626' });
      toolbarLabel.textContent = 'Bar Chart';
    } else {
      activeSeries = chart.addLineSeries({ color: '#2563eb', lineWidth: 2, crosshairMarkerVisible: true });
      toolbarLabel.textContent = 'Line Chart';
    }

    activeSeries.setData(data);

    // ‚îÄ‚îÄ Volume histogram ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Each bar = up + down volume; green if up >= down, red if down > up.
    if (hasVolume) {
      const volSeries = chart.addHistogramSeries({
        priceFormat:  { type: 'volume' },
        priceScaleId: 'vol',
      });

      chart.priceScale('vol').applyOptions({
        scaleMargins: { top: 0.78, bottom: 0 },
        visible: false,
      });

      volSeries.setData(data.map(d => {
        const up   = d.upVol   || 0;
        const down = d.downVol || 0;
        return {
          time:  d.time,
          value: up + down,
          color: up >= down ? 'rgba(22, 163, 74, 0.55)' : 'rgba(220, 38, 38, 0.55)',
        };
      }));
    }

    chart.timeScale().fitContent();
    chart.applyOptions({ width: chartContainer.clientWidth });
  }

  // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function fmtVol(v) {
    if (v >= 1e9) return (v / 1e9).toFixed(2) + 'B';
    if (v >= 1e6) return (v / 1e6).toFixed(2) + 'M';
    if (v >= 1e3) return (v / 1e3).toFixed(1) + 'K';
    return v.toLocaleString();
  }

  function updateStats(data, filename) {
    const maxH = Math.max(...data.map(d => d.high));
    const minL = Math.min(...data.map(d => d.low));
    const fmt  = v => v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 });

    statCandles.textContent  = data.length.toLocaleString();
    statFrom.textContent     = formatTimeLabel(data[0].time);
    statTo.textContent       = formatTimeLabel(data[data.length - 1].time);
    statHigh.textContent     = fmt(maxH);
    statLow.textContent      = fmt(minL);
    statFilename.textContent = filename;

    const hasVolume = data.some(d => d.upVol !== undefined || d.downVol !== undefined);
    if (hasVolume) {
      const totalUp   = data.reduce((s, d) => s + (d.upVol   || 0), 0);
      const totalDown = data.reduce((s, d) => s + (d.downVol || 0), 0);
      statUpVol.textContent    = fmtVol(totalUp);
      statDownVol.textContent  = fmtVol(totalDown);
      volDivider.style.display = '';
      statUpWrap.style.display = '';
      statDownWrap.style.display = '';
    } else {
      volDivider.style.display   = 'none';
      statUpWrap.style.display   = 'none';
      statDownWrap.style.display = 'none';
    }

    statsBar.style.display     = 'flex';
    chartWrapper.style.display = 'block';
  }

  // ‚îÄ‚îÄ Main flow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function processFile(file) {
    clearError();
    if (!file.name.toLowerCase().endsWith('.csv')) {
      showError('Please upload a .csv file.');
      return;
    }

    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = parseCSV(e.target.result);
        parsedData  = data;
        currentFile = file.name;
        setActiveBtn(currentMode);
        renderChart(data);
        updateStats(data, file.name);
      } catch (err) {
        showError(err.message);
        statsBar.style.display     = 'none';
        chartWrapper.style.display = 'none';
      }
    };
    reader.readAsText(file);
    fileInput.value = '';
  }
</script>

</body>
</html>
